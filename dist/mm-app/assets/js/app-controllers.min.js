function MasterController(e,t,o,l,i,s,r,n){function a(){c.fileupload.filesCompleted==c.fileupload.files.length&&(c.fileupload.filesUploading=!1,c.fileupload.doneUploading=!0,t.$broadcast("FILEUPLOAD-COMPLETED"))}function d(e,t,l){s.getTranscodeProgress(o.getTranscodingProgress,t,l).then(function(o){console.log("s",o),"true"==o.status?(c.fileupload.files[e].processing=o.data.progress,100==o.data.progress?(c.fileupload.files[e].success=!0,c.fileupload.filesSuccessCount++,c.fileupload.files[e].done=!0,c.fileupload.filesCompleted++,a()):setTimeout(function(){d(e,t,l)},1e3)):(c.fileupload.files[e].error=!0,c.fileupload.files[e].errorMsg=o.message,c.fileupload.files[e].processing=100,c.fileupload.filesErrorCount++,c.fileupload.filesCompleted++,a())},function(t){c.fileupload.files[e].processing=100,c.fileupload.files[e].error=!0,c.fileupload.filesErrorCount++,c.fileupload.filesCompleted++,a()})}var c=this;c.version=o.version,c.APP_CONST=o,c.OPEN_ID="",c.OPEN_MODE="",c.ALLOWED_IMAGES=["JPEG","JPG","GIF","PNG","BMP","TIFF","TIF","SVG","PDF"],c.ALLOWED_VIDEOS=["MP4","WEBM","AVI","MKV","WAV","WMV","OGG","OGV","FLV","MOV","3GP","M4V"],c.ALLOWED_AUDIOS=["WAV","OGG","AAC","AC3","M4A","MP3"],c.ALLOWED_FILES=["HTML","HTM","PHP"],c.ALLOWED_FILETYPES=c.ALLOWED_IMAGES.concat(c.ALLOWED_VIDEOS).concat(c.ALLOWED_AUDIOS).concat(c.ALLOWED_FILES),c.transcoding=o.transcoding,c.$rootScope=t,c.$timeout=l,c.firstLevelFilters=o.firstLevelFilters,c.pixiePath="pixie/index.php",c.APP_CONST.restrictionMessage="Max file size allowed is "+(c.APP_CONST.maxUploadFileSize/1048576).toFixed(0)+"MB. ",c.APP_CONST.restrictionMessage+="<br/>Allowed File Type: ",_.each(c.ALLOWED_FILETYPES,function(e,t){var o=t+1==c.ALLOWED_FILETYPES.length?"":", ";c.APP_CONST.restrictionMessage+=e+o}),c.selected={text:"",items:[]},c.folders={list:[],selected:"0",manager:{enabled:!1,add:{string:"",focus:"0",submit:function(e,t){if(angular.isUndefined(e)||""==e)return r.error("Need a Folder Name"),!1;var o=Math.floor(10*Math.random())+""+(new Date).getTime(),l=t?c.folders.manager.add.focus:c.folders.selected;l=""==l?"0":l,c.$rootScope.$broadcast("MM-FOLDERS-ADD",{id:o,name:e,parent:l,struncture:c.folders.list,type:"ADD"}),c.folders.manager.add.string="",t&&(c.folders.manager.add.focus="0")}},edit:function(e,t){if(angular.isUndefined(t)||""==t)return r.error("Need a Folder Name"),!1;c.$rootScope.$broadcast("MM-FOLDERS-EDIT",{data:c.folders.list,type:"EDIT",id:e,name:t})},delete:function(e){c.$rootScope.$broadcast("MM-FOLDERS-DELETE",{data:c.folders.list,type:"DELETE",id:e})},ondrop:function(e){c.$rootScope.$broadcast("MM-FOLDERS-ONDROP",{data:e,type:"ONDROP",id:e.id})}},treeOptions:{dragStop:function(e){c.$rootScope.$broadcast("MM-FOLDERS-UPDATE",{data:c.folders.list,type:"UPDATE"})}},filterStrict:function(e,t){return""===t||angular.equals(t,e)}},c.filter={show:!0,type:"",search:{enabled:!1,string:""},orderBy:"name",sortReverse:!1,onclick:function(e){c.filter.type=e==c.filter.type?"":e}},c.addItems={enabled:!1,virtualFile:{name:"",type:"video",create:function(){t.$broadcast("VFILE-CREATE-REQUEST")}}},c.fileupload={enabled:!1,multiple:!1,files:[],filesUploading:!1,filesCompleted:0,filesSuccessCount:0,filesErrorCount:0,addFiles:function(e){return e.length&&l(function(){c.addItems.enabled=!1,c.fileupload.enabled=!0,c.prepUpload(e)}),!1},close:function(){c.fileupload.enabled=!1,c.fileupload.files=[],t.$broadcast("FILEUPLOAD-CLOSED")},removeItem:function(e){var t=c.fileupload.files.indexOf(e);c.fileupload.files.splice(t,1)}},c.prepUpload=function(e){var t=e.length;if(c.fileupload.filesCompleted=0,c.fileupload.filesSuccessCount=0,c.fileupload.filesErrorCount=0,c.fileupload.filesUploading=!1,c.fileupload.doneUploading=!1,t)for(var o=0;o<t;o++){var l=e[o];l.id="00",l.progress=0,l.processing=0,l.done=!1,l.error=!1,l.errorMsg=!1,l.success=!1,l.sizeMB=(l.size/1048576).toFixed(1)+" MB ",l.targetFolder=c.folders.selected;var i=l.name.split(".").pop().toUpperCase();_.contains(c.ALLOWED_FILETYPES,i)||(l.error=!0,l.done=!0,l.errorMsg="This File Type ("+i+") Not Allowed",c.fileupload.filesErrorCount++),l.size>c.APP_CONST.maxUploadFileSize&&(l.error=!0,l.done=!0,l.errorMsg="File too big ("+l.sizeMB+"), Max size "+(c.APP_CONST.maxUploadFileSize/1048576).toFixed(0)+"MB",c.fileupload.filesErrorCount++),c.fileupload.files.push(l)}return!1},c.doUpload=function(){if(!c.fileupload.files.length)return!1;c.fileupload.filesUploading=!0;for(var e=0;e<c.fileupload.files.length;e++){var t=c.fileupload.files[e];t.id=e,t.done?(c.fileupload.filesCompleted++,a()):s.upload(o.fileuploadPath+"?targetFolder="+t.targetFolder,t,e).then(function(e){if("true"==e.data.status)if(c.fileupload.files[e.id].error=!1,c.fileupload.files[e.id].errorMsg="",c.transcoding){var t=n.encode(JSON.stringify(e.data.data));new d(e.id,e.data.data.name_new,encodeURIComponent(t))}else c.fileupload.files[e.id].success=!0,c.fileupload.filesSuccessCount++,c.fileupload.files[e.id].done=!0,c.fileupload.filesCompleted++,a();else c.fileupload.files[e.id].success=!1,c.fileupload.files[e.id].error=!0,c.fileupload.files[e.id].errorMsg=e.data.message,c.fileupload.filesErrorCount++,c.fileupload.files[e.id].done=!0,c.fileupload.filesCompleted++,a()},function(e){c.fileupload.files[e.id].success=!1,c.fileupload.files[e.id].error=!0,c.fileupload.files[e.id].errorMsg="File Upload Error [E1001]",c.fileupload.files[e.id].done=!0,c.fileupload.filesErrorCount++,c.fileupload.filesCompleted++,a()},function(e){c.fileupload.files[e.id].progress=e.complete})}return!1},c.showInfo=function(){swal({html:o.restrictionMessage,width:600,customClass:"info-swal ico-info",showConfirmButton:!1,showCloseButton:!0,padding:0})},c.showItemInfo=function(e,t){e.stopPropagation();var o="<div>";"image"==t.type&&(o+='<div class="media-prev image"><img src="'+t.thumbnails.orginal+'"/></div>'),"video"==t.type&&(o+='<div class="media-prev video"><video src="'+t.path+'" controls></video></div>'),"audio"==t.type&&(o+='<div class="media-prev audio"><audio src="'+t.path+'" controls></audio></div>'),o+="<div>",o+='<div class="control-label">Name</div>',o+='<div class="control-text">'+t.name+"</div>",o+="</div>",o+='<div class="row">',o+='<div class="col-xs-6">',o+='<div class="control-label">Size</div>',o+='<div class="control-text">'+t.size+"</div>",o+="</div>","audio"!=t.type&&(o+='<div class="col-xs-6">',o+='<div class="control-label">Dimension</div>',o+='<div class="control-text">'+t.width+" by "+t.height+"</div>",o+="</div>"),o+="</div>",o+="<div>",o+='<div class="control-label">Created</div>',o+='<div class="control-text">'+t.create_date+"</div>",o+="</div>",o+='<div class="text-center">',o+='<a href="'+t.path_download+'" target="_blank" class="btn btn-link btn-swal" download="'+t.name+'">Download</a>',o+="</div>",o+="</div>",swal({html:o,confirmButtonClass:"btn btn-link",buttonsStyling:!1,width:600,customClass:"info-swal ico-info",showConfirmButton:!1,showCloseButton:!0,padding:0,allowEnterKey:!1}).catch(swal.noop)}}function updateQueryStringParameter(e,t,o){var l=new RegExp("([?&])"+t+"=.*?(&|$)","i"),i=-1!==e.indexOf("?")?"&":"?";return e.match(l)?e.replace(l,"$1"+t+"="+o+"$2"):e+i+t+"="+o}function ListingController(e,t,o,l,i,s,r,n){function a(t,o){console.log(o),s.postFolderSave(o).then(function(t){"true"==(t=t.data).status?("ADD"==o.type&&e.masterController.mmFolderInsertItem(e.masterController.folders.list.items,o.id,o.parent,o.name,function(e){}),"DELETE"==o.type&&e.masterController.mmFolderRemoveItem(e.masterController.folders.list.items,o.id,function(){e.masterController.folders.selected="0"}),n.success("Changes Saved.")):n.error(t.message+" [XHR]")},function(){n.error("Error Adding Folders [E2001]")})}e.masterController.pageClass="page-images",e.masterController.OPEN_ID=l.id,e.showLoading=!0,e.mediaLoaded=!1,e.params=l,e.consts=o,e.filterEnabled=!1,e.addEnaled=!1,e.mediaList=[],e.folderList=[],angular.isUndefined(e.params.filterType)||(e.masterController.filter.type=e.params.filterType),angular.isUndefined(e.params.selectMode)||(e.masterController.OPEN_MODE=e.params.selectMode.toUpperCase().trim(),e.masterController.fileupload.multiple="MULTIPLE"==e.masterController.OPEN_MODE||"MANAGE"==e.masterController.OPEN_MODE),angular.isUndefined(e.params.selectFolder)||(e.masterController.folders.selected=e.params.selectFolder),e.getData=function(t){e.showLoading=!0,e.mediaLoaded=!1,s.getMediaListing(t).then(function(t){e.mediaList=t,i(function(){e.showLoading=!1,e.mediaLoaded=!0},500),e.masterController.selected.items=[]},function(t){n.error("Error Getting Data [E1002]"),e.showLoading=!1,e.mediaLoaded=!0})},e.getFolders=function(){e.showLoading=!0,s.getFolderList().then(function(t){e.masterController.folders.list=t,e.showLoading=!1},function(t){n.error("Error Getting Folders [E1003]"),e.showLoading=!1})},e.selectItem=function(t,o){if(o.selected){o.selected=!1;var l=e.masterController.selected.items.indexOf(o);angular.isUndefined(l)||e.masterController.selected.items.splice(l,1),e.masterController.selected.text=e.masterController.selected.items.length>1?"Items Selected":"Item Selected"}else("MULTIPLE"==e.masterController.OPEN_MODE||"MANAGE"==e.masterController.OPEN_MODE||e.masterController.selected.items.length<1)&&(o.selected=!0,e.masterController.selected.items.push(o),e.masterController.selected.text=e.masterController.selected.items.length>1?"Items Selected":"Item Selected");return!1},e.clearSelected=function(){_.each(e.mediaList,function(t,o){t.selected=!1,o+1==e.mediaList.length&&(e.masterController.selected.items=[])})},e.buildEditorLink=function(t){var o=e.masterController.pixiePath+"?id="+t.id;return o+="&folder="+e.masterController.folders.selected,o+="&name="+t.name.replace(" ","_"),o+="&ext="+t.ext,o+="&image_path="+window.encodeURIComponent(t.path),o+="&save_path="+window.encodeURIComponent(e.consts.postPixieImageCreate),o+="&callback_path="+window.encodeURIComponent(updateQueryStringParameter(window.location.href,"selectFolder",e.masterController.folders.selected))},e.$on("FILEUPLOAD-COMPLETED",function(){n.success("Changes Saved. Reloading Media List."),e.getData(e.params.selectFolder)}),e.$on("MM-ITEMS-DELETED",function(t,o){e.showLoading=!0,s.postMediaDelete(o).then(function(){n.success("Changes Saved. Reloading Media List."),e.getData(e.params.selectFolder)})}),e.$on("VFILE-CREATE-REQUEST",function(){""!=e.masterController.addItems.virtualFile.name&&(e.masterController.addItems.enabled=!1,e.showLoading=!0,s.postVirtualFile({id:e.masterController.OPEN_ID,name:e.masterController.addItems.virtualFile.name,type:e.masterController.addItems.virtualFile.type,targetFolder:""==e.masterController.folders.selected?"0":e.masterController.folders.selected}).then(function(){e.masterController.addItems.virtualFile.name="",n.success("Changes Saved. Reloading Media List."),e.getData(e.params.selectFolder)}))}),e.$on("MM-FOLDERS-ADD",a),e.$on("MM-FOLDERS-EDIT",a),e.$on("MM-FOLDERS-UPDATE",a),e.$on("MM-FOLDERS-DELETE",a),e.$on("MM-FOLDERS-ONDROP",function(t,o){e.masterController.selected.items.length?_.each(e.masterController.selected.items,function(t,l){t.folder=o.id,l+1==e.masterController.selected.items.length&&s.postMediaUpdates(e.masterController.selected.items).then(function(){e.clearSelected(),r.debug("Media Updates Posted")})}):console.log("Nothing to Drop")}),e.getFolders(),e.getData(e.params.selectFolder)}function SidebarController(e){e.menuOptions=[['<i class="fa fa-info-circle"></i> Info',function(e){console.log(e.folder);var t=e.folder.count_folders<1?"":e.folder.count_folders+" folder";t=e.folder.count_folders>1?t+"s ":"",t=e.folder.count_files<1?t:t+e.folder.count_files+" file",t=""==(t=e.folder.count_files>1?t+"s ":t+"")?"Empty":t;var o="<div>";o+="<div>",o+='<div class="control-label">Name</div>',o+='<div class="control-text">'+e.folder.name+"</div>",o+="</div>",o+='<div class="row">',o+='<div class="col-xs-6">',o+='<div class="control-label">Total Size</div>',o+='<div class="control-text">'+e.folder.size+"</div>",o+="</div>",o+='<div class="col-xs-6">',o+='<div class="control-label">Contains</div>',o+='<div class="control-text">'+t+"</div>",o+="</div>",o+="</div>",o+="<div>",o+='<div class="control-label">Created</div>',o+='<div class="control-text">'+e.folder.create_date+"</div>",o+="</div>",o+="</div>",swal({html:o,confirmButtonClass:"btn btn-link",buttonsStyling:!1,width:600,customClass:"info-swal ico-folder",showConfirmButton:!1,showCloseButton:!0,padding:0}).catch(swal.noop)}],null,['<i class="fa fa-pencil"></i> Rename',function(t){swal({title:"Rename Folder",input:"text",showCancelButton:!0,confirmButtonText:"Rename",confirmButtonClass:"btn btn-success btn-swal",cancelButtonClass:"btn btn-link pull-left btn-swal",reverseButtons:!0,buttonsStyling:!1,customClass:"info-swal ico-rename",inputValue:t.folder.name,width:600,allowOutsideClick:!1}).then(function(o){""!==o&&(t.folder.name=o,e.masterController.folders.manager.edit(t.folder.id,o))}).catch(swal.noop)}],['<i class="fa fa-trash-o"></i> Delete',function(t){var o='<div class="dc-content">';o+="<h3>Warning: this cannot be undone.</h3>",o+='<div class="checkedbox checked"> All Sub-Folders linked to the Folder will be <strong>deleted</strong>.</div>',o+='<div class="checkedbox checked"> All Media Files linked to the Folder will be <strong>deleted</strong>.</div>',o+='<div class="checkedbox checked"> All content linked to the Media in the Folders will be <strong>broken</strong>.</div>',o+="</div>",swal({title:"Delete "+t.folder.name,html:o,showCancelButton:!0,cancelButtonClass:"btn btn-link pull-left btn-swal",reverseButtons:!0,buttonsStyling:!1,customClass:"info-swal ico-remove",confirmButtonClass:"btn btn-danger btn-swal",confirmButtonText:"Yes, Delete it!",width:700,allowEnterKey:!1}).then(function(){e.masterController.folders.manager.delete(t.folder.id)}).catch(swal.noop)}]]}angular.module("mediaManager").controller("MasterController",["$scope","$rootScope","APP_CONST","$timeout","$q","UploadFactory","growl","$base64",MasterController]),MasterController.prototype.closeMessage=function(e){var t=this,o={id:e,action:"close"};parent.postMessage(JSON.stringify(o),t.APP_CONST.postmessageParent)},MasterController.prototype.makeSelection=function(e,t){var o=this,l={id:e,action:"select",items:t};parent.postMessage(JSON.stringify(l),o.APP_CONST.postmessageParent)},MasterController.prototype.deleteSelection=function(e,t,o){e.stopPropagation();var l=this,i=o.length>1?"items":"item",s='<div class="dc-content">';return s+="<h3>Warning: this cannot be undone.</h3>",s+='<div class="checkedbox checked"> You have selected '+o.length+" "+i+".</div>",s+='<div class="checkedbox checked"> Selected media '+i+" will be <strong>permenantly deleted</strong>.</div>",s+='<div class="checkedbox checked"> All content linked to the item will be <strong>broken</strong>.</div>',s+="</div>",swal({title:"Delete Media",html:s,showCancelButton:!0,cancelButtonClass:"btn btn-link pull-left btn-swal",reverseButtons:!0,buttonsStyling:!1,customClass:"info-swal ico-remove",confirmButtonClass:"btn btn-danger btn-swal",confirmButtonText:"Yes, Delete it!",width:700,allowEnterKey:!1}).then(function(){l.$rootScope.$broadcast("MM-ITEMS-DELETED",{id:t,items:o})}).catch(swal.noop),!1},MasterController.prototype.getPixieLink=function(e){var t=this,o=t.pixiePath+"?id=000";return o+="&folder="+t.folders.selected,o+="&name=New_Image",o+="&ext=png",o+="&image_path=",o+="&save_path="+window.encodeURIComponent(t.APP_CONST.postPixieImageCreate),o+="&callback_path="+window.encodeURIComponent(updateQueryStringParameter(window.location.href,"selectFolder",t.folders.selected))},MasterController.prototype.mmFolderInsertItem=function(e,t,o,l,i){var s=this;if("0"==o){var r={id:t,name:l,items:[]};e.push(r),"function"==typeof i&&i(r)}else _.each(e,function(e){if(e.id==o){var r={id:t,name:l,items:[]};e.items.push(r),"function"==typeof i&&i(r)}else e.items.length&&s.mmFolderInsertItem(e.items,t,o,l,i)});return null},MasterController.prototype.mmFolderRemoveItem=function(e,t,o){var l=this;return _.each(e,function(i){angular.isUndefined(i)||(i.id==t?(e.splice(_.indexOf(e,i),1),"function"==typeof o&&o()):i.items.length&&l.mmFolderRemoveItem(i.items,t,o))}),null},angular.module("mediaManager").controller("ListingController",["$scope","$rootScope","APP_CONST","$stateParams","$timeout","DataFactory","$log","growl",ListingController]),angular.module("mediaManager").controller("SidebarController",["$scope",SidebarController]);